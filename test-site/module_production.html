
<!DOCTYPE html>
<html>
<head>
  <title>Microinverter Power Grid</title>
    <style>
    body { font-family: sans-serif; background: #f4f7fa; }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 5px;
      margin: 5px;
    }
    .cell {
      border: 1px solid #ccc;
      padding: 3px;
      text-align: center;
      font-size: 12px;
      border-radius: 6px;
      transition: background-color 0.3s ease, color 0.3s ease;
      color: white; /* default color for dark backgrounds */
    }
    .cell .serial {
      font-weight: bold;
      font-size: 10px;
      margin-bottom: 2px;
      display: block;
    }
    #loadingOverlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      z-index: 9999;
      display: none;
    }
    input[type=range] {
      appearance: none;
      width: 90%;
      height: 8px;
      background: #ccc;
      border-radius: 3px;
      outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 24px;
      height: 24px;
      background-color: darkorange;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.9);
      animation: pulse 2s infinite;
    }
    input[type=range]::-moz-range-thumb {
      width: 24px;
      height: 24px;
      background-color: darkorange;
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 0 6px rgba(0, 0, 0, 0.9);
      animation: pulse 2s infinite;
    }
    #imageWrapper {
      position: relative;
      display: inline-block;
      width: 100%;
      max-width: 1000px;
        }
    #imageWrapper img {
      width: 100%;
      height: auto;
      display: block;
    }
    #slideWrapper {
      width: 100vw;
      position: relative;
      height: 100%;
      padding-top: 10px;
      padding-bottom: 10px;
    }
    #contentSpace{
      position: relative;
      width: 500vw;
      height: 100vh;
      display: flex;
      box-sizing: border-box;
    }
    .arrayImages{
      position: relative;
      width: 476.25px;
      height: 268px;
      max-width: 100%;
      max-height: 100%;
      z-index: 1;
    }
    #leftArrayButton{
      width: 6%;
      height: 13%;
      position: absolute;
      top: 32.5%;
      left: 45.5%; 
      transform: translate(-50%, -50%);
      border: none;
    }
    #middleArrayButton{
      width: 15%;
      height: 29%;
      position: absolute;
      top: 39.5%;
      left: 57.5%; 
      transform: translate(-50%, -50%);
      border: none;
    }
    #rightArrayButton{
      width: 23%;
      height: 47.5%;
      position: absolute;
      top: 46%;
      left: 81%; 
      transform: translate(-50%, -50%);
      border: none;
    }
    #bottomArrayButton{
      width: 42%;
      height: 52%;
      position: absolute;
      top: 65%;
      left: 29%; 
      transform: translate(-50%, -50%);
      border: none;
    }
    #bottomArrayButton2{
      width: 20%;
      height: 40%;
      position: absolute;
      top: 74%;
      left: 60%; 
      transform: translate(-50%, -50%);
      border: none;
    }
    .chartContainers{
      width: 100%;
    }
    .Sliders{
      width: 100%;
    }
    #fullArray{
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      width: 100vw;
      height: 100vh;
      gap: 25px;
      box-sizing: border-box;
    }
    #leftArray, #middleArray, #rightArray, #bottomArray{
      display: flex;
      flex-direction: row;
      align-items: center;
      justify-content: center;
      width: 100vw;
      height: 100vh;
      gap: 25px;
      box-sizing: border-box;
    }
    #leftArrayContent, #middleArrayContent, #rightArrayContent, #bottomArrayContent{
      display: grid;
    }
    #leftArrayContent div, #middleArrayContent div, #rightArrayContent div, #bottomArrayContent div{
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: rgb(255, 255, 255);
      height: 100%;
      align-items: center;
      text-align: center;
      flex: 1;
    }
    #leftArrayContent{
      grid-template-columns: repeat(5, 42.5px);
      grid-auto-rows: 80px;
      transform: translateX(119px);
      grid-column-gap: 2.5px;
    }
    #leftArrayContent div{
      background-color: rgba(204, 0, 0, 0.418);
      font-size: 8px;
    }
    
    #middleArrayContent{
      grid-template-columns: repeat(6, 38.8px);
      grid-auto-rows: 75px;
      grid-row-gap: 5px;
      grid-column-gap: 5.75px;
      transform: translateX(128.8px);
    }
   #middleArrayContent div span{
    font-size: 8px;
   }
    #middleArrayContent div{
      background-color: rgba(204, 0, 0, 0.418);
    }
    #rightArrayContent{
      grid-template-columns: repeat(4, 37.5px);
      grid-auto-rows: 75px;
      transform: translateX(185px);
      grid-column-gap: 7px;
      grid-row-gap: 2.5px;
    }
    #rightArrayContent div{
      background-color: rgba(204, 0, 0, 0.418);
    }
   #rightArrayContent div span{
    font-size: 8px;
   }
    #bottomArrayContent{
      grid-template-columns: repeat(23,16.25px);
      grid-auto-rows: 30px;
      grid-row-gap: 20px;
      grid-column-gap: 1.5px;
      transform: translateX(26.25px);
    }
    #bottomArrayContent div{
      background-color: rgba(204, 0, 0, 0.418);
      gap: 4px;
    }
   #bottomArrayContent div span{
    font-size: 5px;
   }
  #sliderAndChart {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 12px;
    width: 100%;
    max-width: 600px;
  }
    #inverter-12{
      grid-column-start: 6;
      grid-column-end: 7;
    }
    #inverter-25{
      grid-column-start: 9;
      grid-column-end: 10;
    }
    #inverter-28{
      grid-column-start: 16;
      grid-column-end: 18;
    }
    #inverter-29{
      grid-column-start: 18;
      grid-column-end: 20;
    }
    #inverter-30{
      grid-column: 1 / 2;
    }
    #inverter-36{
      grid-column: 7 / 9;
    }
    #inverter-37{
      grid-column: 9 / 11;
    }
    #inverter-74{
      grid-column: 4 / 5;
    }
    #inverter-77{
      grid-column: 10 / 11;
    }
    #inverter-82{
      grid-column: 18 / 20;
    }
    #inverter-83{
      grid-column: 20 / 22;
    }
    #inverter-84{
      grid-column: 22 / 24;
    }
    .landscape-top {
      align-self: start;
      height: 50% !important;
      padding-top: 2px;
      padding-bottom: 2px;
    }
    .landscape-bottom {
      align-self: end;
      height: 50% !important;
      padding-top: 2px;
      padding-bottom: 2px;
    }
  @keyframes pulse {
      0% { box-shadow: 0 0 0px rgba(255, 255, 0, 0.5); }
      50% { box-shadow: 0 0 12px rgba(255, 255, 0, 0.9); }
      100% { box-shadow: 0 0 0px rgba(255, 255, 0, 0.5); }
    }
  
</style>
</head>
<body style="width: 1000vw; height: 1000vh; margin: 0; background: #f4f7fa;">

  <div id="slideWrapper">
    <div id="contentSpace">
      <div id="fullArray">
        <div id="imgAndArray">
          <h1 id="fullArrayTitle">Click to view parts of the solar energy system</h1>
          <div id="imageWrapper">
            <img src="images/array_full.JPG" alt="Full Array">
            <button id="leftArrayButton" data-index="1" class="arrayButtons"></button>
            <button id="middleArrayButton" data-index="2" class="arrayButtons"></button>
            <button id="rightArrayButton" data-index="3" class="arrayButtons"></button>
            <button id="bottomArrayButton" data-index="4" class="arrayButtons"></button>
            <button id="bottomArrayButton2" data-index="4" class="arrayButtons"></button>
          </div>
        </div>
        <div id="sliderAndChart">
          <label for="fullDatePicker">Select Date:</label>
          <input type="date" id="fullDatePicker" class="datePickers" min="2025-06-09"/><br><br>
          <div id="fullChartContainer" class="chartContainers">
            <canvas id="fullChart"></canvas>
          </div>
          <div id="fullPowerValue">
            Site Power: -- W
          </div>
          <label for="fullSlider">Select Time: <span id="fullTimeLabel"></span></label><br>
          <input type="range" class="Sliders" id="fullSlider" min="0" max="287" step="1" value="287" />
          </div>
      </div>
      <div id="leftArray">
        <div id="imgAndArray">
          <img src="images/array_wall_left.JPG" class="arrayImages" alt="Left Array">
          <div id="leftArrayContent"></div>
        </div>
        <div id="sliderAndChart">
          <label for="leftDatePicker">Select Date:</label>
          <input type="date" id="leftDatePicker" class="datePickers" min="2025-06-09"/><br><br>
          <div id="leftChartContainer" class="chartContainers">
            <canvas id="leftChart"></canvas>
          </div>
          <div id="leftPowerValue">
            Site Power: -- W
          </div>
          <label for="leftSlider">Select Time: <span id="leftTimeLabel"></span></label><br>
          <input type="range" class="Sliders" id="leftSlider" min="0" max="287" step="1" value="287" />
          <button class="returnButtons">Return to full system</button>
        </div>
      </div>
      <div id="middleArray">
        <div id="imgAndArray">
          <img src="images/array_wall_middle.JPG" class="arrayImages" alt="Middle Array">
          <div id="middleArrayContent"></div>
        </div>
        <div id="sliderAndChart">
          <label for="middleDatePicker">Select Date:</label>
          <input type="date" id="middleDatePicker" class="datePickers" min="2025-06-09"/><br><br>
          <div id="middleChartContainer" class="chartContainers">
            <canvas id="middleChart"></canvas>
          </div>
          <div id="middlePowerValue">
            Site Power: -- W
          </div>
          <label for="middleSlider">Select Time: <span id="middleTimeLabel"></span></label><br>
          <input type="range" class="Sliders" id="middleSlider" min="0" max="287" step="1" value="287" />
          <button class="returnButtons">Return to full system</button>
        </div>
      </div>
      <div id="rightArray">
        <div id="imgAndArray">
          <img src="images/array_wall_right.JPG" class="arrayImages" alt="Right Array">
          <div id="rightArrayContent"></div>
        </div>
        <div id="sliderAndChart">
          <label for="rightDatePicker">Select Date:</label>
          <input type="date" id="rightDatePicker" class="datePickers" min="2025-06-09"/><br><br>
          <div id="rightChartContainer" class="chartContainers">
            <canvas id="rightChart"></canvas>
          </div>
          <div id="rightPowerValue">
            Site Power: -- W
          </div>
          <label for="rightSlider">Select Time: <span id="rightTimeLabel"></span></label><br>
          <input type="range" class="Sliders" id="rightSlider" min="0" max="287" step="1" value="287" />
          <button class="returnButtons">Return to full system</button>
        </div>
      </div>
      <div id="bottomArray">
        <div id="imgAndArray">
          <img src="images/array_bottom.JPG" class="arrayImages" alt="Bottom Array">
          <div id="bottomArrayContent"></div>  
        </div>
        <div id="sliderAndChart">
          <label for="bottomDatePicker">Select Date:</label>
          <input type="date" id="bottomDatePicker" class="datePickers" min="2025-06-09"/><br><br>
          <div id="bottomChartContainer" class="chartContainers">
            <canvas id="bottomChart"></canvas>
          </div>
          <div id="bottomPowerValue">
            Site Power: -- W
          </div>
          <label for="bottomSlider">Select Time: <span id="bottomTimeLabel"></span></label><br>
          <input type="range" class="Sliders" id="bottomSlider" min="0" max="287" step="1" value="287" />
          <button class="returnButtons">Return to full system</button>
        </div>
      </div>
    </div>
  </div>

  <hr style="margin: 0; border: none; height: 1px; background: #ccc;">
  <div class="grid" id="grid" style="width: 90%; padding: 10px; box-sizing: border-box; display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 10px;"></div>
  <div id="loadingOverlay">Loading data...</div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>

    const slideElement = document.getElementById("contentSpace");
    const grid = document.getElementById("grid");
    const leftArrayContent = document.getElementById("leftArrayContent")
    const middleArrayContent = document.getElementById("middleArrayContent")
    const rightArrayContent = document.getElementById("rightArrayContent")
    const bottomArrayContent = document.getElementById("bottomArrayContent")
    const slider = document.getElementById("timeSlider");
    const timeLabel = document.getElementById("timeLabel");
    const datePicker = document.getElementById("fullDatePicker");
    const loadingOverlay = document.getElementById("loadingOverlay");
    const fullChart = document.getElementById("fullChart");
    const leftChart = document.getElementById("leftChart");
    const middleChart = document.getElementById("middleChart");
    const rightChart = document.getElementById("rightChart");
    const bottomChart = document.getElementById("bottomChart");
    const fullSlider = document.getElementById("fullSlider");
    const leftSlider = document.getElementById("leftSlider");
    const middleSlider= document.getElementById("middleSlider");
    const rightSlider = document.getElementById("rightSlider");
    const bottomSlider = document.getElementById("bottomSlider");

    const debounceTimers = {};
    let devices = [];
    let powerCache = {}; // { serial_number: [ { measurement_date, value }, ... ] }
    let sunriseMinutes = 0;
    let sunsetMinutes = 1435;
    
    //arrays of inverter serial numbers per array (from left to right, top to bottom)
    const inverters = [
      {serial : 202350032713, array: "left", orientation : "portrait"},
      {serial : 202350033317, array: "left", orientation : "portrait"},
      {serial : 202350033239, array: "left", orientation : "portrait"},
      {serial : 202350033023, array: "left", orientation : "portrait"},
      {serial : 202350033266, array: "left", orientation : "portrait"},
    
      {serial : 202350033279, array: "middle", orientation : "portrait"},
      {serial : 202350033325, array: "middle", orientation : "portrait"},
      {serial : 202350033282, array: "middle", orientation : "portrait"},
      {serial : 202350033368, array: "middle", orientation : "portrait"},
      {serial : 202350034217, array: "middle", orientation : "portrait"},
      {serial : 202350032986, array: "middle", orientation : "portrait"},
      {serial : 202350022939, array: "middle", orientation : "portrait"},
      {serial : 202350029826, array: "middle", orientation : "portrait"},

      {serial : 202350031298, array: "right", orientation : "portrait"},
      {serial : 202350032703, array: "right", orientation : "portrait"},
      {serial : 202350031277, array: "right", orientation : "portrait"},
      {serial : 202350031285, array: "right", orientation : "portrait"},
      {serial : 202350031167, array: "right", orientation : "portrait"},
      {serial : 202350031279, array: "right", orientation : "portrait"},
      {serial : 202350033727, array: "right", orientation : "portrait"},
      {serial : 202350032746, array: "right", orientation : "portrait"},

      {serial : 202407025848, array: "bottom", orientation : "portrait"}, //starts at 21
      {serial : 202407022085, array: "bottom", orientation : "portrait"},
      {serial : 202407025020, array: "bottom", orientation : "portrait"},
      {serial : 202407020754, array: "bottom", orientation : "portrait"},

      {serial : 202407022326, array: "bottom", orientation : "portrait"},
      {serial : 202407025800, array: "bottom", orientation : "portrait"},
      {serial : 202407024732, array: "bottom", orientation : "portrait"},

      {serial : 202407025859, array: "bottom", orientation : "landscape-bottom"}, //sideways
      {serial : 202407024632, array: "bottom", orientation : "landscape-bottom"}, //sideways

      {serial : 202407023931, array: "bottom", orientation : "portrait"},
      {serial : 202407025004, array: "bottom", orientation : "portrait"},
      {serial : 202407025071, array: "bottom", orientation : "portrait"},
      {serial : 202407024776, array: "bottom", orientation : "portrait"},
      {serial : 202407021365, array: "bottom", orientation : "portrait"},
      {serial : 202407024884, array: "bottom", orientation : "portrait"},
      {serial : 202407024662, array: "bottom", orientation : "landscape-top"}, //sideways
      {serial : 202407025726, array: "bottom", orientation : "landscape-top"}, //sideways
      {serial : 202407026081, array: "bottom", orientation : "portrait"},
      {serial : 202407024968, array: "bottom", orientation : "portrait"},
      {serial : 202407025562, array: "bottom", orientation : "portrait"},
      {serial : 202407025725, array: "bottom", orientation : "portrait"},
      {serial : 202407025186, array: "bottom", orientation : "portrait"},
      {serial : 202407028485, array: "bottom", orientation : "portrait"},
      {serial : 202407025807, array: "bottom", orientation : "portrait"},
      {serial : 202407026237, array: "bottom", orientation : "portrait"},
      {serial : 202407025220, array: "bottom", orientation : "portrait"},
      {serial : 202407025555, array: "bottom", orientation : "portrait"},
      {serial : 202407028124, array: "bottom", orientation : "portrait"},
      {serial : 202407025710, array: "bottom", orientation : "portrait"},
      {serial : 202407025932, array: "bottom", orientation : "portrait"},

      {serial : 202407020257, array: "bottom", orientation : "portrait"},
      {serial : 202407024769, array: "bottom", orientation : "portrait"},
      {serial : 202407024621, array: "bottom", orientation : "portrait"},
      {serial : 202407022392, array: "bottom", orientation : "portrait"},
      {serial : 202407024312, array: "bottom", orientation : "portrait"},
      {serial : 202407022325, array: "bottom", orientation : "portrait"},
      {serial : 202407024184, array: "bottom", orientation : "portrait"},
      {serial : 202407025028, array: "bottom", orientation : "portrait"},
      {serial : 202407022101, array: "bottom", orientation : "portrait"},
      {serial : 202407027034, array: "bottom", orientation : "portrait"},
      {serial : 202407026805, array: "bottom", orientation : "portrait"},
      {serial : 202407026897, array: "bottom", orientation : "portrait"},
      {serial : 202407025709, array: "bottom", orientation : "portrait"},
      {serial : 202407022093, array: "bottom", orientation : "portrait"},
      {serial : 202407024357, array: "bottom", orientation : "portrait"},
      {serial : 202407023804, array: "bottom", orientation : "portrait"},
      {serial : 202407020899, array: "bottom", orientation : "portrait"},
      {serial : 202407024045, array: "bottom", orientation : "portrait"},
      {serial : 202407023996, array: "bottom", orientation : "portrait"},
      {serial : 202407023489, array: "bottom", orientation : "portrait"},
      {serial : 202407023433, array: "bottom", orientation : "portrait"},
      {serial : 202407026933, array: "bottom", orientation : "portrait"},
      {serial : 202407023651, array: "bottom", orientation : "portrait"},

      {serial : 202407025291, array: "bottom", orientation : "portrait"},
      {serial : 202407025447, array: "bottom", orientation : "portrait"},
      {serial : 202407025270, array: "bottom", orientation : "portrait"},

      {serial : 202407025567, array: "bottom", orientation : "portrait"},
      {serial : 202407027734, array: "bottom", orientation : "portrait"},
      {serial : 202407025051, array: "bottom", orientation : "portrait"},
      {serial : 202407025304, array: "bottom", orientation : "portrait"},
      {serial : 202407025716, array: "bottom", orientation : "portrait"},

      {serial : 202407024806, array: "bottom", orientation : "landscape-top"}, //sideways
      {serial : 202407023585, array: "bottom", orientation : "landscape-top"}, //sideways
      {serial : 202407024093, array: "bottom", orientation : "landscape-top"}, //sideways

      {serial : 202407025292, array: "bottom", orientation : "portrait"},
      {serial : 202407025806, array: "bottom", orientation : "portrait"},
      {serial : 202407025453, array: "bottom", orientation : "portrait"},
      {serial : 202407025280, array: "bottom", orientation : "portrait"},
      {serial : 202407025472, array: "bottom", orientation : "portrait"}
    ]
    document.querySelectorAll(".arrayButtons").forEach(button => {
      button.addEventListener("click", function () {
        slideElement.style.transform = "";
        const elementIndex = parseInt(this.getAttribute("data-index"), 10);
        const translationFactor = elementIndex * 20;
        slideElement.style.transform = `translateX(-${translationFactor}%)`;
      });
    });
    document.querySelectorAll(".returnButtons").forEach(button => {
      button.addEventListener("click", function () {
        slideElement.style.transform = `translateX(0%)`;
      });
    });
    async function constrainSliderToSunHours() {
      const dateStr = datePicker.value;
      const res = await fetch(`https://clients.hakaienergy.ca/camosun/date_sun_info.php?date=${dateStr}`);
      const json = await res.json();
      if (json.sunrise && json.sunset) {
        const sunrise = new Date(json.sunrise * 1000);
        const sunset = new Date(json.sunset * 1000);
        sunriseMinutes = sunrise.getHours() * 60 + sunrise.getMinutes();
        sunsetMinutes = sunset.getHours() * 60 + sunset.getMinutes();
        document.querySelectorAll(".Sliders").forEach(slider =>{
          slider.min = Math.floor(sunriseMinutes / 5);
          slider.max = Math.floor(sunsetMinutes / 5);
          slider.value = slider.max;
        })
      }
    }
    async function getSunHours(){
      let timeArray = [];
      const dateStr = datePicker.value;
      const res = await fetch(`https://clients.hakaienergy.ca/camosun/date_sun_info.php?date=${dateStr}`);
      const json = await res.json();
      if (json.sunrise && json.sunset) {
        const sunrise = new Date(json.sunrise * 1000);
        const sunset = new Date(json.sunset * 1000);
        sunriseMinutes = sunrise.getHours() * 60 + sunrise.getMinutes();
        sunsetMinutes = sunset.getHours() * 60 + sunset.getMinutes();
        for(let i = sunriseMinutes; i < sunsetMinutes; i+= 5){
          const time = Math.floor(i/5);
          timeArray.push(time);
        }
        return timeArray;
      }
      else{
        return null;
      }
    }
    async function getSunBoundaries(){
      let timeArray = [];
      const dateStr = datePicker.value;
      const res = await fetch(`https://clients.hakaienergy.ca/camosun/date_sun_info.php?date=${dateStr}`);
      const json = await res.json();
      if (json.sunrise && json.sunset) {
        const sunrise = new Date(json.sunrise * 1000);
        const sunset = new Date(json.sunset * 1000);
        const sunriseMinutes = sunrise.getHours() * 60 + sunrise.getMinutes();
        const sunsetMinutes = sunset.getHours() * 60 + sunset.getMinutes();
        const sunriseTime = sliderToTime(sunriseMinutes/5);
        const sunsetTime = sliderToTime(sunsetMinutes/5);
        timeArray.push(sunriseTime);
        timeArray.push(sunsetTime);
        return timeArray;
      }
      else{
        return null;
      }
    }
    function buildGrid(inverterArray){
      if(typeof inverterArray == "undefined"){
        return;
      }
      leftArrayContent.innerHTML = "";
      middleArrayContent.innerHTML = "";
      rightArrayContent.innerHTML = "";
      bottomArrayContent.innerHTML = "";
      inverterArray.forEach((inverter, inverterIndex) =>{
        const cell = document.createElement("div");
        cell.id= `inverter-${inverterIndex}`;
        cell.innerHTML = `
          <span class="power">loading...</span>
          <span class="kwh">- kWh</span>`;
        if(inverter.orientation == "landscape-top"){
          cell.classList.add("landscape-top");
        }
        else if(inverter.orientation == "landscape-bottom"){
          cell.classList.add("landscape-bottom");
        }
        switch (inverter.array) {
          case "left":
            leftArrayContent.appendChild(cell);
            break;
          case "middle":
            middleArrayContent.appendChild(cell);
            break;
          case "right":
            rightArrayContent.appendChild(cell);
            break;
          case "bottom":
            bottomArrayContent.appendChild(cell);
            break;
        }
      })
    }

    function sliderToTime(sliderValue) {
      const selectedDate = datePicker.value;
      if (!selectedDate) return null;

      const date = new Date(selectedDate + "T00:00:00");
      date.setMinutes(sliderValue * 5);

      const pad = n => n.toString().padStart(2, '0');
      console.log(`${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:00`)
      return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())} ${pad(date.getHours())}:${pad(date.getMinutes())}:00`;
    }

    async function updateFullChart() {
      const selectedDate = datePicker.value;
      const ctx = fullChart.getContext("2d");
      const timeStr = sliderToTime(parseInt(fullSlider.value));
      if (!timeStr) return;
      fullTimeLabel.textContent = timeStr;

      try {
        const res = await fetch(`https://clients.hakaienergy.ca/camosun/get_site_power.php?r=${selectedDate}`);
        const json = await res.json();

        const filtered = json.filter(e => e.measurement_date.startsWith(selectedDate));
        const dataPoints = filtered.map(e => {
          const [h, m] = e.measurement_date.split(" ")[1].split(":");
          return { x: (parseInt(h) * 60 + parseInt(m)) / 5, y: e.value };
        });
        
        // Update visible site power at current slider step
        const currentStep = parseInt(fullSlider.value);
        let nearest = dataPoints.reduce((a, b) => Math.abs(b.x - currentStep) < Math.abs(a.x - currentStep) ? b : a, dataPoints[0]);
        document.getElementById("fullPowerValue").textContent = `Site Power: ${nearest?.y ?? '--'} W`;



    if (window.fullSummaryChart) {
      window.fullSummaryChart.data.datasets[0].data = dataPoints;
      window.fullSummaryChart.update();
    } else {
      window.fullSummaryChart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: 'Site Power (W)',
            data: dataPoints,
            borderColor: 'orange',
            backgroundColor: 'rgba(255,165,0,0.2)',
            fill: true,
            pointRadius: 0,
            tension: 0.2
          }]
        },
        options: {
          animation: false,
          plugins: {
            legend: { display: false }
          },
          scales: {
            x: {
              type: 'linear',
              title: { display: true, text: 'Time of Day' },
              ticks: {
                stepSize: 12,
                callback: v => {
                  const hh = Math.floor(v * 5 / 60).toString().padStart(2, '0');
                  const mm = (v * 5 % 60).toString().padStart(2, '0');
                  return `${hh}:${mm}`;
                }
              }
            },
            y: {
              beginAtZero: true,
              min: 0
            }
          }
        },
        plugins: [{
          id: 'sliderDot',
          afterDatasetsDraw(chart) {
            const step = parseInt(fullSlider.value);
            const dataset = chart.data.datasets[0];
            if (!dataset || !dataset.data.length) return;

            // Find the closest point
            const point = dataset.data.reduce((closest, p) =>
              Math.abs(p.x - step) < Math.abs(closest.x - step) ? p : closest, dataset.data[0]);

            const x = chart.scales.x.getPixelForValue(point.x);
            const y = chart.scales.y.getPixelForValue(point.y);

            const ctx = chart.ctx;
            ctx.save();
            ctx.fillStyle = 'red';
            ctx.beginPath();
            ctx.arc(x, y, 10, 0, 2 * Math.PI);
            ctx.fill();
            ctx.restore();
          }
        }]
      });
    }
  } catch (err) {
    console.warn("Failed to load site power summary:", err);
  }
} 

    async function loadPowerData(inverterArray) {
      if(typeof inverterArray == "undefined"){
        console.error("array does not exist");
      }
      loadingOverlay.style.display = 'flex';
      powerCache = {};
      const promises = inverterArray.map(async inverter => {
        try {
          const url = `https://clients.hakaienergy.ca/camosun/get_device_power.php?device_id=${inverter.serial}&r=${datePicker.value}`;
          const res = await fetch(url);
          if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
          const json = await res.json();
          powerCache[inverter.serial] = json;
        } catch (err) {
          console.warn(`Error loading ${inverter.serial}:`, err);
          powerCache[inverter.serial] = [];
        }
      });
      await Promise.all(promises);

    }

    function powerToColor(value) {
      const clamped = Math.max(0, Math.min(500, value));
      const intensity = Math.round((clamped / 500) * 255);
      return `rgb(${intensity}, 0, 0)`;
    }
    
    function computeKWhForDay(serial) {
      const entries = powerCache[serial] || [];
      const totalWatts = entries.reduce((sum, entry) => sum + (entry.value || 0), 0);
      return (totalWatts * 5 / 60 / 1000).toFixed(2); // convert to kWh, rounded
    }
    async function updateAllArrays(inverterArray, arrayPosition, sliderObject) {
      if(typeof sliderObject == "undefined"){
        sliderObject = slider;
      }
      if(typeof inverterArray == "undefined"){
        console.error("inverter array does not exist");
        return;
      }

      const timeStr = sliderToTime(parseInt(sliderObject.value));
      if (!timeStr) return;
      const arrayTimeLabel = document.getElementById(`${arrayPosition}TimeLabel`);
      arrayTimeLabel.textContent = timeStr;

      const invertersToAdjust = inverters.filter(item => getArrayLocation(item, arrayPosition));

      const timeBoundaries = await getSunBoundaries();
      console.log("timeBoundaries = ", timeBoundaries);
      console.log("typeof getSunBoundaries = ", typeof getSunBoundaries);
      await updateArrayCharts(invertersToAdjust, sliderObject, arrayPosition);
      invertersToAdjust.forEach((inverter, inverterIndex) => {
        const entries = powerCache[inverter.serial] || [];
        const match = entries.find(entry => entry.measurement_date === timeStr);
        const power = match ? match.value : null;

        const fullIndex = inverters.findIndex(inv => inv.serial === inverter.serial);
        const cell = document.getElementById(`inverter-${fullIndex}`);
        if (cell) {
          const bgColor = power !== null ? powerToColor(power) : 'transparent';
          const kwh = computeKWhForDay(inverter.serial);
          cell.querySelector(".kwh").textContent = kwh ? `${kwh} kWh` : 'N/A';
          cell.querySelector(".power").textContent = power !== null ? `${power} W` : 'N/A';
          cell.style.backgroundColor = bgColor;
          cell.style.color = power !== null ? 'white' : 'black';
        }
      });
    }
    function createSliderDotPlugin(sliderObject) {
      return {
        id: 'sliderDot',
        afterDatasetsDraw(chart) {
          if (!sliderObject || !sliderObject.value) return;
          const step = parseInt(sliderObject.value);
          const dataset = chart.data.datasets[0];
          if (!dataset || !dataset.data.length) return;

          const point = dataset.data.reduce((closest, p) =>
            Math.abs(p.x - step) < Math.abs(closest.x - step) ? p : closest,
            dataset.data[0]
          );

          const x = chart.scales.x.getPixelForValue(point.x);
          const y = chart.scales.y.getPixelForValue(point.y);

          const ctx = chart.ctx;
          ctx.save();
          ctx.fillStyle = 'red';
          ctx.beginPath();
          ctx.arc(x, y, 10, 0, 2 * Math.PI);
          ctx.fill();
          ctx.restore();
        }
      };
    }
    async function updateArrayCharts(inverterArray, sliderObject, arrayPosition) {
      if (!sliderObject || !sliderObject.value) {
        sliderObject = document.getElementById("timeSlider");
      }

      const selectedDate = datePicker.value;
      const ctx = document.getElementById(`${arrayPosition}Chart`).getContext("2d");
      const timeBoundaries = await getSunBoundaries();


      if (!window.chartDataCache) {
        window.chartDataCache = {};
      }
      if (!window.chartDataCache[arrayPosition]) {
        window.chartDataCache[arrayPosition] = {};
      }

      let chartData;


      if (window.chartDataCache[arrayPosition][selectedDate]) {
        chartData = window.chartDataCache[arrayPosition][selectedDate];
      } else {

        const url = `https://clients.hakaienergy.ca/camosun/get_device_power.php?device_id=${inverterArray[0].serial}&r=${selectedDate}`;

        function findLastBeforeOrEqual(data, targetTime) {
          let lastValidIndex = -1;
          for (let i = 0; i < data.length; i++) {
            if (data[i].measurement_date <= targetTime) {
              lastValidIndex = i;
            } else {
              break;
            }
          }
          return lastValidIndex;
        }

        try {
          const res = await fetch(url);
          const data = await res.json();

          if (!data || !data.length) {
            console.warn(`No data for inverter ${inverterArray[0].serial} on ${selectedDate}`);
            return;
          }

          const initialIndex = findLastBeforeOrEqual(data, timeBoundaries[0]);
          const finalIndex = findLastBeforeOrEqual(data, timeBoundaries[1]);

          if (initialIndex === -1 || finalIndex === -1 || finalIndex <= initialIndex) {
            console.warn(`Invalid data range for ${selectedDate}: ${timeBoundaries[0]}â€“${timeBoundaries[1]}`);
            return;
          }

          const timeMap = new Map();
          for (let j = initialIndex; j <= finalIndex; j++) {
            const entry = data[j];
            timeMap.set(entry.measurement_date, entry.value);
          }

          for (let k = 1; k < inverterArray.length; k++) {
            const inverterUrl = `https://clients.hakaienergy.ca/camosun/get_device_power.php?device_id=${inverterArray[k].serial}&r=${selectedDate}`;
            const tempRes = await fetch(inverterUrl);
            const sortedData = await tempRes.json();

            for (let entry of sortedData) {
              if (timeMap.has(entry.measurement_date)) {
                timeMap.set(entry.measurement_date, timeMap.get(entry.measurement_date) + entry.value);
              }
            }
          }

          chartData = [];
          for (let [timestamp, value] of timeMap.entries()) {
            const [h, m] = timestamp.split(" ")[1].split(":");
            chartData.push({
              x: (parseInt(h) * 60 + parseInt(m)) / 5,
              y: value
            });
          }

          window.chartDataCache[arrayPosition][selectedDate] = chartData;

        } catch (err) {
          console.warn(`Error fetching data for inverter ${inverterArray[0].serial}:`, err);
          return;
        }
      }


      const currentStep = parseInt(sliderObject.value);
      const nearest = chartData.reduce((a, b) =>
        Math.abs(b.x - currentStep) < Math.abs(a.x - currentStep) ? b : a, chartData[0]);
      document.getElementById(`${arrayPosition}PowerValue`).textContent = `Site Power: ${nearest?.y ?? '--'} W`;

      if (!window.arrayCharts) window.arrayCharts = {};

      if (window.arrayCharts[arrayPosition]) {
        window.arrayCharts[arrayPosition].data.datasets[0].data = chartData;
        window.arrayCharts[arrayPosition].update();
      } else {
        window.arrayCharts[arrayPosition] = new Chart(ctx, {
          type: 'line',
          data: {
            datasets: [{
              label: 'Site Power (W)',
              data: chartData,
              borderColor: 'orange',
              backgroundColor: 'rgba(255,165,0,0.2)',
              fill: true,
              pointRadius: 0,
              tension: 0.2
            }]
          },
          options: {
            animation: false,
            plugins: { legend: { display: false } },
            scales: {
              x: {
                type: 'linear',
                title: { display: true, text: 'Time of Day' },
                ticks: {
                  stepSize: 12,
                  callback: v => {
                    const hh = Math.floor(v * 5 / 60).toString().padStart(2, '0');
                    const mm = (v * 5 % 60).toString().padStart(2, '0');
                    return `${hh}:${mm}`;
                  }
                }
              },
              y: {
                beginAtZero: true,
                min: 0
              }
            }
          },
          plugins: [createSliderDotPlugin(sliderObject)]
        });
      }
    }

    function getArrayLocation(item, location){
      return item.array === location;
    }
    function debounce(func, delay) {
      let timeout;
      return function (...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    } 
    async function updateAllCharts(){
      updateFullChart();
      updateAllArrays(inverters, "left", leftSlider);
      updateAllArrays(inverters, "right", rightSlider);
      updateAllArrays(inverters, "middle", middleSlider);
      updateAllArrays(inverters, "bottom", bottomSlider).then(() =>{
        loadingOverlay.style.display = 'none';
      })
    }
    document.querySelectorAll(".Sliders").forEach(slider => {
      slider.addEventListener("input", (event) => {
        const id = slider.id;
        
        clearTimeout(debounceTimers[id]);

        debounceTimers[id] = setTimeout(() => {
          switch (id) {
            case "fullSlider":
              updateFullChart();
              break;
            case "leftSlider":
              updateAllArrays(inverters, "left", slider);
              break;
            case "rightSlider":
              updateAllArrays(inverters, "right", slider);
              break;
            case "middleSlider":
              updateAllArrays(inverters, "middle", slider);
              break;
            case "bottomSlider":
              updateAllArrays(inverters, "bottom", slider);
              break;
          }
        }, 70);
      });
    });

    document.querySelectorAll(".datePickers").forEach(datePicker =>{
      datePicker.addEventListener("change", () =>{
        dateChanged(datePicker);
      });
    })
    async function dateChanged(datePicker){
      const newDate = datePicker.value;
      document.querySelectorAll(".datePickers").forEach(picker => {
        picker.value = newDate;
      });
      buildGrid(inverters);
      await constrainSliderToSunHours();
      await loadPowerData(inverters).then(updateAllCharts);
    }
    function getYesterday(){
      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const offset = yesterday.getTimezoneOffset();
      const localYesterday = new Date(yesterday.getTime() - offset * 60 * 1000);
      const formattedDate = localYesterday.toISOString().split('T')[0];
      return formattedDate;
    }
    async function onStart(){
      document.querySelectorAll(".datePickers").forEach(datePicker =>{
        datePicker.value = getYesterday()
        const yesterdayString = String(getYesterday());
        datePicker.max=yesterdayString;
      })
      dateChanged(fullDatePicker);
    }
    onStart();
    const invertersInLocation = inverters.filter(item => getArrayLocation(item, "right"));
    console.log(invertersInLocation);
  </script>
</body>
</html>
